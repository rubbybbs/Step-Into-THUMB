<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>管理员</title>
  <link rel="stylesheet" href="../static/layui/css/layui.css" media="all">
  <style type="text/css">
    a{color:#009688;}
    a:hover{color:#8ddad2;}
  </style>
</head>

<body class="layui-layout-body">
  <div class="layui-layout layui-layout-admin">
    <div class="layui-header">
      <div class="layui-logo"> <a href="activity.html">军乐队活动管理 </a></div>

      <ul class="layui-nav layui-layout-right">
        
        <li class="layui-nav-item" lay-unselect="">
          <a href="javascript:;"><img src="../static/illust_72066950_20181219_203453.jpg" class="layui-nav-img">管理员</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">修改信息</a></dd>
            <dd><a href="javascript:;">安全管理</a></dd>
            <dd><a href="index.html">退出</a></dd>
          </dl>
        </li>
      </ul>
    </div>

    <div class="layui-side layui-bg-black">
      <div class="layui-side-scroll">
        <ul class="layui-nav layui-nav-tree" lay-filter="test">
          <li class="layui-nav-item">
            <a href="modify.html">定制报名表</a>           
          </li>
          <li class="layui-nav-item">
            <a href="segment.html">定制环节</a>
          </li>
          <li class="layui-nav-item">
            <a href="accountManage.html">考官账号管理</a></dd>
          </li>

        </ul>
      </div>
    </div>

    <div class="layui-body" , lay-filter="graph">
      <div style="padding: 20px; background-color: #F2F2F2;">
        <div class="layui-row layui-col-space15">
          <div class="layui-col-md12">
            <div class="layui-card">
              <div class="layui-card-body">
                <form class="layui-form" action="" lay-filter="FormDesign"> {%  csrf_token %}                    
                          

                  <div class="layui-card">
                    <div class="layui-card-body" id="toAdd">
                        <div class="layui-tab" lay-filter="activitySegment">

                            <ul class="layui-tab-title" id="titleToAdd">
                              <li class="layui-this" lay-id="0">初试</li>
                              <li lay-id="1">复试</li>
                            </ul>
                            
                            <div class="layui-form-item" style="margin-top: 15px;">
                              <button type="button" class="layui-btn" id="DeleteSegment">删除当前环节</button>
                              <button type="submit" class="layui-btn" lay-submit="" lay-filter="submitForm">保存当前环节</button>
                              <button type="button" class="layui-btn" id="NewSegment">添加新环节</button>
                            </div>

                            <div class="layui-tab-content" id="contentToAdd">
                              <div class="layui-tab-item layui-show"></div>
                              <div class="layui-tab-item"></div>
                            </div>
                        </div>
                    </div>
                  </div>                                

                  <div class="layui-card">
                      <div class="layui-card-body">
                          <div class="layui-form-item">
                                <button type="button" class="layui-btn" id="NewDataLine">添加新数据项</button>
                          </div>
                      </div>
                  </div>      
                </form>
              </div>
            </div>           
          </div>


        </div>
      </div>
    </div>



  </div>

  <div class="layui-footer">
    <!-- 底部固定区域 -->
    © 小组：基于layui以及django
  </div>
  </div>


  <script src="../static/layui/layui.js"></script>
  <script>
    var currentSegmentNum = 0;
    var Quz = new Array();
    var Segments = new Array();

    //此处需删除
    Quz.push({id:layui.data('LocalData').ActID,
      question:new Array()});

    layui.use(['form', 'layedit', 'laydate', 'jquery', 'layer', 'element'], function () {
      var form = layui.form,
        layer = layui.layer,
        $ = layui.jquery,
        layedit = layui.layedit,
        laydate = layui.laydate,
        element = layui.element;;

      layer.ready(function(){
        var LocalData=layui.data('LocalData');
        layer.msg('初始化列表'+LocalData.ActID.toString());


        // #TODO:接入接口
        element.tabAdd('activitySegment', {
              title: '新选项'+ (Math.random()*1000|0) //用于演示
              ,content: '内容'+ (Math.random()*1000|0)
              ,id: currentSegmentNum
        });
        //#TODO 通过ajax获取数据并解析
      });

      //监听提交
      form.on('submit(submitForm)', function (data) {
        alert(JSON.stringify(Quz));

        //#TODO 通过ajax获取数据并解析
        return false;
      });

      $("#NewDataLine").click(function() {  
        currentSegmentNum = parseInt($(".layui-this").attr("lay-id"));
        // 创建数据行的弹出层
        layer.open({
          id: "NewLineSet",
          title: '添加新数据项',
          shadeClose: true,
          shade: 0.8,
          area: ['450px', '400px'],
          content: '\
            <form class="layui-form" action="" lay-filter="FormNewLine">{%  csrf_token %}\
                <div class="layui-form-item">\
                  <label class="layui-form-label">数据项</label>\
                  <div class="layui-input-block">\
                    <input type="text" name="Info" lay-verify="title" autocomplete="off" placeholder="请输入数据项名称" class="layui-input">\
                  </div>\
                </div>\
                <div class="layui-form-item">\
                  <label class="layui-form-label">附加信息</label>\
                  <div class="layui-input-block">\
                    <input type="text" name="AppendInfo" lay-verify="title" autocomplete="off" placeholder="若插入选择框，请输入各选项（以|隔开）" class="layui-input">\
                  </div>\
                </div>\
                <div class="layui-form-item"> \
                  <label class="layui-form-label">题目类型</label> \
                  <div class="layui-input-block"> \
                    <select name="LineType" lay-filter="LineType"> \
                      <option value="0">填空</option>\
                      <option value="1">选择</option>\
                    </select> \
                  </div> \
                </div>\
            </form>',
          success: function (layero, index) {
            form.render();
          },
          btn: ['确认', '取消'],
          yes: function (index, layero) {
            var Fdata = form.val('FormNewLine');

            if (Fdata.LineType == "0") {
              Quz[currentSegmentNum]["question"].push({
                name: Fdata.Info,
                type: "Blank"
              });
              $(".layui-show").append(
                '<div class="layui-form-item"> \
                    <label class="layui-form-label">' + Fdata.Info + '</label> \
                    <div class="layui-input-block"> \
                      <input type="text" autocomplete="off" placeholder="' + Fdata.AppendInfo + '" class="layui-input" style="width:70%;display:inline;"> \
                      <button type="button" class="layui-btn" name="DeleteLine">删除</button>\
                    </div> \
                </div>'    
              );
              form.render();
            } else if (Fdata.LineType == "1"){
              var strs = new Array(); 
              strs = Fdata.AppendInfo.split("|");
              var ChoiceArr=new Array();
              strs.map(function(value,index,arr){
                ChoiceArr.push({Choice:value});
              });
              Quz[currentSegmentNum]["question"].push({
                name: Fdata.Info,
                type: "Choice",
                Choices: ChoiceArr
              });
              
              var modestr = 
                '<div class="layui-form-item"> \
                  <div class="layui-inline">\
                    <label class="layui-form-label">' + Fdata.Info + '</label> \
                    <div class="layui-input-inline" > \
                      <select name="example" lay-filter="show"> \
                        <option value=""></option> ';
                          strs.map(function(value,index,arr){
                            modestr += '<option value="' + index.toString() + '">' + value + '</option>';
                          });               
                          modestr += '</select> \
                    </div> \
                  </div>\
                  <div class="layui-inline" > \
                    <button type="button" class="layui-btn" name="DeleteLine">删除</button>\
                  </div>\
                </div>';
              $(".layui-show").append(modestr);
              //alert(modestr);
              form.render();
            }
            layer.close(index);
          },
          btn2: function (index, layero) {}
        });
      });
      
      $("#toAdd").on("click", "[name='DeleteLine']",function(){
        var mParent = this.parentNode.parentNode;
        var topic = mParent.firstElementChild.innerText;
        var deleteIndex=-1;
        currentSegmentNum = parseInt($(".layui-this").attr("lay-id"));
        Quz[currentSegmentNum]['question'].map(function(value, index){
          alert(topic);
          if (value.name == topic) {
            deleteIndex=index;    
          }
        });
        if (deleteIndex!=-1){
          Quz[currentSegmentNum]['question'].splice(deleteIndex, 1);
        }
        
        mParent.remove();
        form.render();
      });

      $("#NewSegment").click(function(){
        // 创建活动的弹出层
        layer.open({
          id: "NewSegmentSet",
          title: '环节基本设置',
          shadeClose: true,
          shade: 0.8,
          area: ['450px', '200px'],
          content: '   \
            <form class="layui-form" action="" lay-filter="FormSegment">{%  csrf_token %}\
              <div class="layui-form-item">\
                <label class="layui-form-label">环节名称</label>\
                <div class="layui-input-block">\
                  <input type="text" name="name" lay-verify="title" autocomplete="off" placeholder="请输入名称" class="layui-input">\
                </div>\
              </div>\
            </form>  ',
          success: function (layero, index) {
            form.render();
          },
          btn: ['确认', '取消'],
          yes: function (index, layero) {
            var Fdata = form.val('FormSegment');
            alert(JSON.stringify(Fdata));
            
            // #TODO 接入接口
            layer.close(index);
            location.reload();
          },
          btn2: function (index, layero) {}
        });

      });
      
      $("#DeleteSegment").click(function(){
        var uid = $(".layui-this").attr("lay-id");

        //#TODO 接入接口
        Quz.splice(parseInt(uid),1);
        element.tabDelete('activitySegment', uid);
      });


    });

  </script>
</body>

</html>